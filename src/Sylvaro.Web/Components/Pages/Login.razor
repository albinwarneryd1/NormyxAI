@page "/login"
@inject Sylvaro.Web.Services.SylvaroApiClient Api
@inject Sylvaro.Web.Services.AuthSession Session
@inject NavigationManager Nav
@inject IJSRuntime JsRuntime

<PageTitle>Sign In - Sylvaro</PageTitle>

<div class="auth-shell">
    <section class="auth-brand-panel">
        <img class="auth-wordmark" src="/brand/sylvaro-wordmark.svg" alt="SYLVARO" />
        <h2>Institutional Governance Access</h2>
        <p>Authenticate to access regulatory intelligence, evidence traceability, and sign-off workflows.</p>
        <p class="metadata-text">Use tenant-scoped credentials issued by your platform administrator.</p>
    </section>

    <section class="card-shell auth-card">
        <h1>Sign In</h1>
        <p>Login with tenant, email and password.</p>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <EnterpriseErrorPanel ErrorText="@_error" FriendlyMessage="Authentication request failed." />
        }

        <EditForm FormName="login-form" Model="_model" OnValidSubmit="OnSubmitAsync">
            <div class="field">
                <label>Tenant</label>
                <InputText @bind-Value="_model.TenantName" class="text-input" />
            </div>
            <div class="field">
                <label>Email</label>
                <InputText @bind-Value="_model.Email" class="text-input" />
            </div>
            <div class="field">
                <label>Password</label>
                <InputText @bind-Value="_model.Password" type="password" class="text-input" />
            </div>
            <button class="btn-main" type="submit" disabled="@_loading">@(_loading ? "Authenticating..." : "Sign In")</button>
        </EditForm>
    </section>
</div>

@code {
    private readonly LoginModel _model = new("NordicFin AB", "admin@nordicfin.example", "ChangeMe123!");
    private bool _loading;
    private string _error = string.Empty;

    private async Task OnSubmitAsync()
    {
        try
        {
            _loading = true;
            _error = string.Empty;

            var response = await Api.PostAsync<Sylvaro.Web.Models.AuthResponse>("/auth/login", new
            {
                tenantName = _model.TenantName,
                email = _model.Email,
                password = _model.Password
            }, withAuth: false);

            if (response is null)
            {
                _error = "Authentication provider returned an empty response.";
                return;
            }

            Session.SetSession(_model.TenantName, _model.Email, response.AccessToken, response.RefreshToken, response.RefreshTokenExpiresAt);
            await Session.PersistAsync(JsRuntime);
            NavigateHome();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateHome()
    {
        try
        {
            Nav.NavigateTo("/", replace: true);
        }
        catch (NavigationException)
        {
            // Blazor can throw this as a control-flow signal in redirect scenarios.
        }
    }

    private sealed record LoginModel(string TenantName, string Email, string Password)
    {
        public string TenantName { get; set; } = TenantName;
        public string Email { get; set; } = Email;
        public string Password { get; set; } = Password;
    }
}
