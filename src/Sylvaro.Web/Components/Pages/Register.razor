@page "/register"
@inject Sylvaro.Web.Services.SylvaroApiClient Api
@inject Sylvaro.Web.Services.AuthSession Session
@inject NavigationManager Nav
@inject IJSRuntime JsRuntime

<PageTitle>Register Tenant - Sylvaro</PageTitle>

<div class="auth-shell">
    <section class="auth-brand-panel">
        <img class="auth-wordmark" src="/brand/sylvaro-wordmark.svg" alt="SYLVARO" />
        <h2>Tenant Provisioning</h2>
        <p>Create a governed tenant workspace and assign the initial administrator account.</p>
        <p class="metadata-text">All provisioning actions are audit-logged and subject to policy controls.</p>
    </section>

    <section class="card-shell auth-card">
        <h1>Register Tenant Organization</h1>
        <p>Provision a governed tenant workspace and primary administrator account.</p>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <EnterpriseErrorPanel ErrorText="@_error" FriendlyMessage="Tenant registration failed." />
        }

        <EditForm FormName="register-form" Model="_model" OnValidSubmit="OnSubmitAsync">
            <div class="field">
                <label>Tenant Name</label>
                <InputText @bind-Value="_model.TenantName" class="text-input" />
            </div>
            <div class="field">
                <label>Email</label>
                <InputText @bind-Value="_model.Email" class="text-input" />
            </div>
            <div class="field">
                <label>Display Name</label>
                <InputText @bind-Value="_model.DisplayName" class="text-input" />
            </div>
            <div class="field">
                <label>Password</label>
                <InputText @bind-Value="_model.Password" type="password" class="text-input" />
            </div>
            <button class="btn-main" type="submit" disabled="@_loading">@(_loading ? "Provisioning..." : "Provision Tenant Workspace")</button>
        </EditForm>
    </section>
</div>

@code {
    private readonly RegisterModel _model = new("", "", "", "");
    private bool _loading;
    private string _error = string.Empty;

    private async Task OnSubmitAsync()
    {
        try
        {
            _loading = true;
            _error = string.Empty;

            var response = await Api.PostAsync<Sylvaro.Web.Models.AuthResponse>("/auth/register", new
            {
                tenantName = _model.TenantName,
                email = _model.Email,
                displayName = _model.DisplayName,
                password = _model.Password
            }, withAuth: false);

            if (response is null)
            {
                _error = "Provisioning service returned an empty response.";
                return;
            }

            Session.SetSession(_model.TenantName, _model.Email, response.AccessToken, response.RefreshToken, response.RefreshTokenExpiresAt);
            await Session.PersistAsync(JsRuntime);
            NavigateHome();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private void NavigateHome()
    {
        try
        {
            Nav.NavigateTo("/", replace: true);
        }
        catch (NavigationException)
        {
            // Blazor can throw this as a control-flow signal in redirect scenarios.
        }
    }

    private sealed record RegisterModel(string TenantName, string Email, string DisplayName, string Password)
    {
        public string TenantName { get; set; } = TenantName;
        public string Email { get; set; } = Email;
        public string DisplayName { get; set; } = DisplayName;
        public string Password { get; set; } = Password;
    }
}
