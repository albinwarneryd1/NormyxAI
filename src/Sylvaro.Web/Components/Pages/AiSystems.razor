@page "/ai-systems"
@inject Sylvaro.Web.Services.SylvaroApiClient Api
@inject Sylvaro.Web.Services.AuthSession Session

<PageTitle>AI Systems - Sylvaro</PageTitle>

@if (!Session.IsInitialized)
{
    <div class="card-shell"><p>Restoring secure session...</p></div>
}
else if (!Session.IsAuthenticated)
{
    <div class="card-shell"><p>Authentication required. Use <a href="/login">Sign In</a> to access the AI system registry.</p></div>
}
else
{
    <div class="section-head">
        <div>
            <h1>AI System Registry</h1>
            <p>Register and maintain AI systems within regulated scope.</p>
        </div>
        <div class="status-line">
            <span class="risk-pill info">Total Systems: @_systems.Count</span>
            <span class="risk-pill success">Active: @_systems.Count(x => x.Status.Equals("Active", StringComparison.OrdinalIgnoreCase))</span>
            <span class="risk-pill warning">Draft: @_systems.Count(x => x.Status.Equals("Draft", StringComparison.OrdinalIgnoreCase))</span>
        </div>
    </div>

    <div class="card-shell">

        <OperationalGuide
            Title="System registration workflow"
            Summary="Use this page to keep your governed AI inventory complete and current."
            Steps="@GuideSteps"
            Actions="@GuideActions" />

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <InstitutionalAlert ErrorText="@_error" FriendlyMessage="AI system registry operation failed." OnRetry="LoadSystemsAsync" />
        }

        <EditForm FormName="ai-systems-create-form" Model="_createForm" OnValidSubmit="CreateSystemAsync">
            <div class="field-grid">
                <InputText @bind-Value="_createForm.Name" class="text-input" placeholder="System name" />
                <InputText @bind-Value="_createForm.Description" class="text-input" placeholder="System purpose and scope" />
            </div>
            <button class="btn-main" type="submit">Register AI System</button>
        </EditForm>

        <div class="field-grid" style="margin-top:0.65rem;">
            <InputText @bind-Value="_searchFilter" class="text-input" placeholder="Search system name" />
            <InputSelect @bind-Value="_statusFilter" class="text-input">
                <option value="">All statuses</option>
                <option value="Active">Active</option>
                <option value="Draft">Draft</option>
                <option value="Paused">Paused</option>
                <option value="Archived">Archived</option>
                <option value="Unknown">Unknown</option>
            </InputSelect>
        </div>

        <table class="table-shell">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Lifecycle Status</th>
                    <th>Versions</th>
                    <th>Updated</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var system in FilteredSystems)
                {
                    <tr>
                        <td>@system.Name</td>
                        <td><span class="@($"risk-pill {ToStatusStyle(system.Status)}")">@system.Status</span></td>
                        <td>@system.VersionCount</td>
                        <td>@system.UpdatedAt.ToString("u")</td>
                        <td><a class="btn-small" href="/ai-systems/@system.Id">Open Workspace</a></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@code {
    private readonly CreateSystemForm _createForm = new();
    private List<Sylvaro.Web.Models.AiSystemListItem> _systems = [];
    private string _error = string.Empty;
    private bool _attemptedInitialLoad;
    private string _searchFilter = string.Empty;
    private string _statusFilter = string.Empty;

    private readonly string[] GuideSteps =
    [
        "Register each in-scope AI system with a clear purpose.",
        "Open Workspace and create a new version when architecture changes.",
        "Run regulatory assessment after each material change.",
        "Track lifecycle status until controls are signed off."
    ];

    private readonly OperationalGuide.GuideAction[] GuideActions =
    [
        new("Go to Exposure Matrix", "/regulatory-exposure"),
        new("Go to Audit Trail", "/audit-log")
    ];

    private IReadOnlyList<Sylvaro.Web.Models.AiSystemListItem> FilteredSystems => _systems
        .Where(x => string.IsNullOrWhiteSpace(_searchFilter) || x.Name.Contains(_searchFilter, StringComparison.OrdinalIgnoreCase))
        .Where(x => string.IsNullOrWhiteSpace(_statusFilter) || x.Status.Equals(_statusFilter, StringComparison.OrdinalIgnoreCase))
        .OrderByDescending(x => x.UpdatedAt)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        if (!Session.IsAuthenticated)
        {
            return;
        }

        _attemptedInitialLoad = true;
        await LoadSystemsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_attemptedInitialLoad || !Session.IsInitialized || !Session.IsAuthenticated)
        {
            return;
        }

        _attemptedInitialLoad = true;
        await LoadSystemsAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task LoadSystemsAsync()
    {
        try
        {
            _systems = (await Api.GetAsync<List<Sylvaro.Web.Models.AiSystemListItem>>("/aisystems")) ?? [];
            _systems = _systems
                .Select(x => x with { Status = Sylvaro.Web.Models.StatusValueNormalizer.NormalizeSystemStatus(x.Status) })
                .ToList();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task CreateSystemAsync()
    {
        try
        {
            _error = string.Empty;
            await Api.PostAsync("/aisystems", new
            {
                name = _createForm.Name,
                description = _createForm.Description,
                ownerUserId = (Guid?)null
            });
            _createForm.Reset();
            await LoadSystemsAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private sealed class CreateSystemForm
    {
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;

        public void Reset()
        {
            Name = string.Empty;
            Description = string.Empty;
        }
    }

    private static string ToStatusStyle(string status)
        => status.ToLowerInvariant() switch
        {
            "active" => "success",
            "paused" => "medium",
            "archived" => "critical",
            "unknown" => "info",
            _ => "warning"
        };
}
